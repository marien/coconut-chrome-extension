<html>
<head>
<script src="jquery-1.6.1.min.js" type="text/javascript"></script>
<script type="text/javascript" >
function getCoconutUrl() {
  var url = "https://coconut.ogd.nl/";
  return url;
}

function isCoconutUrl(url) {
  var coconut = getCoconutUrl();
  if (url.indexOf(coconut) != 0)
    return false;

  return url; //.length == coconut.length || url[coconut.length] == '?' ||
              //         url[gmail.length] == '#';
}

function goToCoconut() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isCoconutUrl(tab.url)) {
        chrome.tabs.update(tab.id, {selected: true});
        return;
      }
    }
    chrome.tabs.create({url: getCoconutUrl()});
  });
}

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
	goToCoconut();
});

var pollInterval = 1000 * 60;
var requestTimeout = 1000 * 2;

function getForumUnreadCount() {
    chrome.browserAction.setBadgeText({text: "." });

	function onSuccess(count) {
		chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
		chrome.browserAction.setBadgeText({text: count != 0 ? count.toString() : ""});
		chrome.browserAction.setIcon({path:"icon19.png"});
		window.setTimeout(getForumUnreadCount, pollInterval);
	}

	function onError() {
		chrome.browserAction.setBadgeText({text: "?"});
		chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
		chrome.browserAction.setIcon({path:"icon19g.png"});
		window.setTimeout(getForumUnreadCount, pollInterval);
	}

	jQuery.ajax({
		url: getCoconutUrl() + 'forum/categories/show_non_read.json',
		timeout: requestTimeout,
		success: function (data) {
			if (data.topics != undefined)
				onSuccess(data.topics.length)
			else
				onError();
		},
		error: function (data) {
			onError();
		}
	});
}

function init() {
  getForumUnreadCount();
}

</script>
</head>
<body onload="init()">
</body>
</html>

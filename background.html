<html>
<head>
<script src="jquery-1.4.2.js" type="text/javascript"></script>
<script type="text/javascript" >
function getTerminalUrl() {
  var url = "https://terminal.ogd.nl/";
  return url;
}

function isTerminalUrl(url) {
  var terminal = getTerminalUrl();
  if (url.indexOf(terminal) != 0)
    return false;

  return url; //.length == terminal.length || url[terminal.length] == '?' ||
              //         url[gmail.length] == '#';
}

function goToTerminal() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isTerminalUrl(tab.url)) {
        chrome.tabs.update(tab.id, {selected: true});
        return;
      }
    }
    chrome.tabs.create({url: getTerminalUrl()});
  });
}

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
	goToTerminal();
});

var pollInterval = 1000 * 60;
var requestTimeout = 1000 * 2;

function getForumUnreadCount() {
    chrome.browserAction.setBadgeText({text: "." });

	function onSuccess(count) {
		chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
		chrome.browserAction.setBadgeText({text: count != 0 ? count.toString() : ""});
		chrome.browserAction.setIcon({path:"icon19.png"});
		window.setTimeout(getForumUnreadCount, pollInterval);
	}

	function onError() {
		chrome.browserAction.setBadgeText({text: "?"});
		chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
		chrome.browserAction.setIcon({path:"icon19g.png"});
		window.setTimeout(getForumUnreadCount, pollInterval);
	}

	jQuery.ajax({
		url: getTerminalUrl() + 'forum/categories/show_non_read.json',
		timeout: requestTimeout,
		success: function (data) {
			if (data.topics != undefined)
				onSuccess(data.topics.length)
			else
				onError();
		},
		error: function (data) {
			onError();
		}
	});
}

function init() {
  getForumUnreadCount();
}

</script>
</head>
<body onload="init()">
</body>
</html>
